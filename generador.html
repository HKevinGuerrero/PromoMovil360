<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generador de Afiche | Promo Móvil 360</title>
  <link rel="icon" type="image/png" href="imagenes/logo.jpg">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .step-indicator { transition: all 0.3s ease; }
    .step-indicator.active { background: linear-gradient(135deg, #C8A750, #AF8D36); color: white; }
    .step-indicator.completed { background: #10b981; color: white; }
    .upload-zone { border: 3px dashed #C8A750; transition: all 0.3s; }
    .upload-zone:hover { border-color: #AF8D36; background: #fef9e7; }
    .upload-zone.dragover { border-color: #AF8D36; background: #fef3c7; }
    .preview-afiche { 
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border: 2px solid #C8A750;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      position: relative;
      overflow: hidden;
    }
    .preview-afiche::before {
      content: 'VISTA PREVIA';
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(200,167,80,0.9);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: bold;
      z-index: 10;
    }
    .spinner { 
      border: 3px solid #f3f3f3;
      border-top: 3px solid #C8A750;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .ai-selector.active {
      border-color: #C8A750;
      background: linear-gradient(135deg, rgba(200,167,80,0.1), rgba(175,141,54,0.05));
    }
    .ai-selector.active i {
      color: #C8A750;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gray-50">
  
  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-3">
        <img src="imagenes/logo.jpg" alt="Logo" class="h-12 w-12 rounded-full">
        <h1 class="text-xl font-bold text-gray-800">Generador de Afiche</h1>
      </a>
      <a href="index.html" class="text-gray-600 hover:text-gray-900">
        <i class="fas fa-times text-xl"></i>
      </a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    
    <!-- Indicador de Pasos -->
    <div class="flex items-center justify-center mb-8 gap-4">
      <div class="step-indicator active flex items-center justify-center w-12 h-12 rounded-full font-bold">
        1
      </div>
      <div class="h-1 w-20 bg-gray-300"></div>
      <div class="step-indicator flex items-center justify-center w-12 h-12 rounded-full font-bold bg-gray-300 text-gray-600">
        2
      </div>
      <div class="h-1 w-20 bg-gray-300"></div>
      <div class="step-indicator flex items-center justify-center w-12 h-12 rounded-full font-bold bg-gray-300 text-gray-600">
        3
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
      
      <!-- Panel Izquierdo: Formulario -->
      <div class="bg-white rounded-2xl shadow-xl p-8">
        
        <!-- Paso 1: Subir Logo -->
        <div id="step1" class="fade-in">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">
            <i class="fas fa-upload text-yellow-600"></i> Sube tu Logo
          </h2>
          <p class="text-gray-600 mb-6">Arrastra o selecciona el logo de tu negocio</p>
          
          <div id="uploadZone" class="upload-zone rounded-xl p-12 text-center cursor-pointer">
            <i class="fas fa-cloud-upload-alt text-6xl text-yellow-600 mb-4"></i>
            <p class="text-gray-700 font-semibold">Arrastra tu logo aquí</p>
            <p class="text-gray-500 text-sm">o haz clic para seleccionar</p>
            <input type="file" id="logoInput" accept="image/*" class="hidden">
          </div>

          <div id="logoPreview" class="mt-6 hidden">
            <img id="logoImg" class="w-full max-w-xs mx-auto rounded-xl shadow-lg">
            <button id="changeLogo" class="mt-4 text-yellow-600 hover:text-yellow-700 font-semibold">
              <i class="fas fa-sync-alt"></i> Cambiar logo
            </button>
          </div>

          <button id="analyzeBtn" class="hidden w-full mt-6 bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-bold py-3 rounded-xl hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-magic"></i> Analizar y Continuar
          </button>
        </div>

        <!-- Paso 2: Información del Negocio -->
        <div id="step2" class="hidden fade-in">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">
            <i class="fas fa-store text-yellow-600"></i> Información del Negocio
          </h2>
          
          <div id="aiSuggestions" class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
            <p class="text-sm font-semibold text-blue-800 mb-2">
              <i class="fas fa-robot"></i> Análisis de IA:
            </p>
            <p id="aiAnalysis" class="text-blue-700 text-sm"></p>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Nombre del Negocio *</label>
              <input type="text" id="businessName" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-500 focus:outline-none" placeholder="Ej: Restaurante El Sabor">
            </div>

            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Tipo de Negocio *</label>
              <select id="businessType" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-500 focus:outline-none">
                <option value="">Selecciona una opción</option>
                <option value="restaurante">Restaurante</option>
                <option value="bar">Bar/Discoteca</option>
                <option value="tienda">Tienda/Boutique</option>
                <option value="salon">Salón de Belleza</option>
                <option value="gimnasio">Gimnasio</option>
                <option value="cafe">Café</option>
                <option value="tecnologia">Tecnología</option>
                <option value="otro">Otro</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Tipo de Promoción *</label>
              <select id="promoType" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-500 focus:outline-none">
                <option value="">Selecciona una opción</option>
                <option value="descuento">Descuento Especial</option>
                <option value="2x1">2x1 u Oferta</option>
                <option value="nuevo">Nuevo Producto/Servicio</option>
                <option value="evento">Evento Especial</option>
                <option value="menu">Menú/Carta</option>
                <option value="redes">Redes Sociales</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Texto de la Promoción *</label>
              <textarea id="promoText" rows="3" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-500 focus:outline-none" placeholder="Ej: 20% de descuento en toda la carta"></textarea>
            </div>

            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Motor de Generación *</label>
              <div class="grid grid-cols-2 gap-3">
                <button type="button" id="aiGemini" class="ai-selector border-2 border-gray-300 rounded-xl p-3 hover:border-yellow-500 transition text-left">
                  <div class="flex items-center gap-2 mb-1">
                    <i class="fab fa-google text-xl"></i>
                    <span class="font-bold">Gemini</span>
                  </div>
                  <p class="text-xs text-gray-600">Google AI - Creativo</p>
                </button>
                <button type="button" id="aiChatGPT" class="ai-selector border-2 border-gray-300 rounded-xl p-3 hover:border-yellow-500 transition text-left">
                  <div class="flex items-center gap-2 mb-1">
                    <i class="fas fa-robot text-xl"></i>
                    <span class="font-bold">ChatGPT</span>
                  </div>
                  <p class="text-xs text-gray-600">OpenAI - Profesional</p>
                </button>
              </div>
            </div>
          </div>

          <div class="flex gap-3 mt-6">
            <button id="backBtn1" class="flex-1 border-2 border-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-50">
              <i class="fas fa-arrow-left"></i> Atrás
            </button>
            <button id="generateBtn" class="flex-1 bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-bold py-3 rounded-xl hover:shadow-lg transition disabled:opacity-50">
              <i class="fas fa-wand-magic-sparkles"></i> Generar Vista Previa
            </button>
          </div>
        </div>

        <!-- Paso 3: Resultado -->
        <div id="step3" class="hidden fade-in">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">
            <i class="fas fa-check-circle text-green-500"></i> ¡Vista Previa Lista!
          </h2>
          <p class="text-gray-600 mb-6">Así se verá tu afiche publicitario</p>

          <div class="bg-gradient-to-br from-green-50 to-blue-50 border-2 border-green-200 rounded-xl p-6 mb-6">
            <p class="text-sm text-gray-700 mb-3">
              <i class="fas fa-info-circle text-blue-500"></i> 
              Esta es solo una vista previa. Para obtener el archivo final de alta calidad:
            </p>
            <ul class="space-y-2 text-sm text-gray-700">
              <li><i class="fas fa-check text-green-500"></i> Contacta con nosotros por WhatsApp</li>
              <li><i class="fas fa-check text-green-500"></i> O completa el formulario de cotización</li>
            </ul>
          </div>

          <div class="flex gap-3">
            <button id="backBtn2" class="flex-1 border-2 border-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-50">
              <i class="fas fa-arrow-left"></i> Modificar
            </button>
            <a href="https://wa.me/573002218219?text=Hola%2C%20me%20gustaría%20obtener%20mi%20afiche%20personalizado" target="_blank" class="flex-1 bg-green-500 text-white font-bold py-3 rounded-xl hover:bg-green-600 text-center">
              <i class="fab fa-whatsapp"></i> Contactar
            </a>
          </div>
        </div>

      </div>

      <!-- Panel Derecho: Vista Previa -->
      <div class="bg-white rounded-2xl shadow-xl p-8 sticky top-24 self-start">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Vista Previa del Afiche</h3>
        
        <div id="affichePreview" class="preview-afiche aspect-[3/4] rounded-xl p-8 flex flex-col items-center justify-center">
          <div id="loadingState" class="text-center">
            <i class="fas fa-image text-6xl text-gray-400 mb-4"></i>
            <p class="text-gray-500">Tu afiche aparecerá aquí</p>
          </div>

          <div id="generatingState" class="hidden text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-700 font-semibold">Generando afiche...</p>
            <p class="text-gray-500 text-sm mt-2">Esto puede tomar unos segundos</p>
          </div>

          <div id="previewContent" class="hidden w-full h-full flex flex-col">
            <!-- El contenido del afiche se generará aquí -->
          </div>
        </div>
      </div>

    </div>
  </main>

<script>
  // === CONFIGURA TU API KEY AQUÍ ===
  const OPENAI_API_KEY = "";
// O deja un texto de ejemplo, pero NUNCA la key real

  // Estado de la aplicación
  let currentStep = 1;
  let logoFile = null;
  let logoBase64 = null;
  let aiAnalysisResult = null;
  let selectedAI = null; // 'gemini' o 'chatgpt'

  // Elementos del DOM
  const uploadZone = document.getElementById('uploadZone');
  const logoInput = document.getElementById('logoInput');
  const logoPreview = document.getElementById('logoPreview');
  const logoImg = document.getElementById('logoImg');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const changeLogo = document.getElementById('changeLogo');

  // Pasos
  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');
  const step3 = document.getElementById('step3');

  // Botones
  const backBtn1 = document.getElementById('backBtn1');
  const backBtn2 = document.getElementById('backBtn2');
  const generateBtn = document.getElementById('generateBtn');

  // Selectores de IA
  const aiGemini = document.getElementById('aiGemini');
  const aiChatGPT = document.getElementById('aiChatGPT');

  // Indicadores
  const stepIndicators = document.querySelectorAll('.step-indicator');

  // Preview
  const loadingState = document.getElementById('loadingState');
  const generatingState = document.getElementById('generatingState');
  const previewContent = document.getElementById('previewContent');

  // === Selección de IA ===
  aiGemini.addEventListener('click', () => {
    selectedAI = 'gemini';
    aiGemini.classList.add('active');
    aiChatGPT.classList.remove('active');
  });

  aiChatGPT.addEventListener('click', () => {
    selectedAI = 'chatgpt';
    aiChatGPT.classList.add('active');
    aiGemini.classList.remove('active');
  });

  // === Navegación entre pasos ===
  function updateStepIndicators() {
    stepIndicators.forEach((indicator, index) => {
      const stepNum = index + 1;
      if (stepNum < currentStep) {
        indicator.classList.add('completed');
        indicator.classList.remove('active');
      } else if (stepNum === currentStep) {
        indicator.classList.add('active');
        indicator.classList.remove('completed');
      } else {
        indicator.classList.remove('active', 'completed');
      }
    });
  }

  function goToStep(stepNum) {
    [step1, step2, step3].forEach(s => s.classList.add('hidden'));

    if (stepNum === 1) step1.classList.remove('hidden');
    if (stepNum === 2) step2.classList.remove('hidden');
    if (stepNum === 3) step3.classList.remove('hidden');

    currentStep = stepNum;
    updateStepIndicators();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // === Upload de logo ===
  uploadZone.addEventListener('click', () => logoInput.click());

  uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
  });

  uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
  });

  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) handleLogoUpload(files[0]);
  });

  logoInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) handleLogoUpload(e.target.files[0]);
  });

  changeLogo.addEventListener('click', () => {
    logoInput.click();
  });

  function handleLogoUpload(file) {
    if (!file.type.startsWith('image/')) {
      alert('Por favor sube un archivo de imagen');
      return;
    }

    logoFile = file;
    const reader = new FileReader();
    
    reader.onload = (e) => {
      logoBase64 = e.target.result;
      logoImg.src = logoBase64;
      uploadZone.classList.add('hidden');
      logoPreview.classList.remove('hidden');
      analyzeBtn.classList.remove('hidden');
    };

    reader.readAsDataURL(file);
  }

  // === Análisis local del logo (sin APIs externas) ===

  function componentToHex(c) {
    const hex = c.toString(16);
    return hex.length === 1 ? "0" + hex : hex;
  }

  function rgbToHex(r, g, b) {
    return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
  }

  function adjustColor(hex, amount) {
    let col = hex.replace('#', '');
    if (col.length === 3) {
      col = col.split('').map(ch => ch + ch).join('');
    }
    let r = parseInt(col.substring(0, 2), 16);
    let g = parseInt(col.substring(2, 4), 16);
    let b = parseInt(col.substring(4, 6), 16);

    r = Math.min(255, Math.max(0, r + amount));
    g = Math.min(255, Math.max(0, g + amount));
    b = Math.min(255, Math.max(0, b + amount));

    return rgbToHex(r, g, b);
  }

  function analyzeLogoWithCanvas() {
    return new Promise((resolve, reject) => {
      if (!logoBase64) {
        reject(new Error('No hay logo cargado'));
        return;
      }

      const img = new Image();
      img.onload = () => {
        const size = 64;
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, size, size);
        const imgData = ctx.getImageData(0, 0, size, size);
        const data = imgData.data;

        let r = 0, g = 0, b = 0, count = 0;

        for (let i = 0; i < data.length; i += 4 * 4) {
          r += data[i];
          g += data[i + 1];
          b += data[i + 2];
          count++;
        }

        r = Math.round(r / count);
        g = Math.round(g / count);
        b = Math.round(b / count);

        const baseHex = rgbToHex(r, g, b);
        const lighter = adjustColor(baseHex, 30);
        const darker = adjustColor(baseHex, -30);

        const result = {
          colores: [baseHex, lighter, darker],
          tipo_negocio_sugerido: document.getElementById('businessType')?.value || '',
          descripcion: 'Colores predominantes detectados automáticamente a partir del logo.'
        };

        resolve(result);
      };

      img.onerror = () => reject(new Error('No se pudo procesar la imagen del logo'));
      img.src = logoBase64;
    });
  }

  analyzeBtn.addEventListener('click', async () => {
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = '<div class="spinner inline-block mr-2" style="width:20px;height:20px;border-width:2px;"></div> Analizando...';

    try {
      aiAnalysisResult = await analyzeLogoWithCanvas();

      if (!document.getElementById('businessType').value && aiAnalysisResult.tipo_negocio_sugerido) {
        document.getElementById('businessType').value = aiAnalysisResult.tipo_negocio_sugerido;
      }

      document.getElementById('aiAnalysis').textContent =
        `Detectamos que tu logo tiene tonos ${aiAnalysisResult.colores.join(', ')}. ${aiAnalysisResult.descripcion}`;

      goToStep(2);
    } catch (error) {
      console.error(error);
      alert('No pudimos analizar el logo automáticamente, pero puedes continuar llenando el formulario manualmente.');
      document.getElementById('aiSuggestions').classList.add('hidden');
      goToStep(2);
    } finally {
      analyzeBtn.disabled = false;
      analyzeBtn.innerHTML = '<i class="fas fa-magic"></i> Analizar y Continuar';
    }
  });

  // === Generar vista previa con IA (DALL·E directamente) ===
  generateBtn.addEventListener('click', async () => {
    const businessName = document.getElementById('businessName').value.trim();
    const businessType = document.getElementById('businessType').value;
    const promoType = document.getElementById('promoType').value;
    const promoText = document.getElementById('promoText').value.trim();

    if (!businessName || !businessType || !promoType || !promoText) {
      alert('Por favor completa todos los campos');
      return;
    }

    if (!selectedAI) {
      alert('Por favor selecciona un motor de generación (Gemini o ChatGPT)');
      return;
    }

    if (selectedAI === 'gemini') {
      alert('Gemini está desactivado por límite de cuota. Usa ChatGPT.');
      return;
    }

    if (!OPENAI_API_KEY || OPENAI_API_KEY === "TU_API_KEY_OPENAI") {
      alert('Configura tu OPENAI_API_KEY en el script.');
      return;
    }

    loadingState.classList.add('hidden');
    generatingState.classList.remove('hidden');
    previewContent.classList.add('hidden');

    try {
      const colors = aiAnalysisResult?.colores || ['#C8A750', '#AF8D36'];

      const prompt = `Crea un afiche publicitario profesional y llamativo para "${businessName}", un negocio de tipo ${businessType}. 
      
Promoción: ${promoText}
Tipo de promoción: ${promoType}

CARACTERÍSTICAS REQUERIDAS:
- Diseño VERTICAL (formato afiche, proporción 3:4)
- Estilo moderno y profesional similar a publicidad de marcas reconocidas
- Usa los colores principales: ${colors.join(', ')}
- Incluye espacio en la parte superior para el logo 
- Tipografía grande e impactante
- Elementos visuales creativos (formas, iconos, gradientes)
- Jerarquía visual clara
- Espacio inferior para un código QR con texto "ESCANÉAME Y AHORRA"
- Sin fotografías de personas o productos reales
- Estilo minimalista pero llamativo

El diseño debe verse profesional, moderno y atraer inmediatamente la atención.`;

      const response = await fetch("/.netlify/functions/generate-image", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ prompt }),
});


      const text = await response.text();

      if (!response.ok) {
        throw new Error(`Error OpenAI (${response.status}): ${text}`);
      }

      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        throw new Error('Respuesta inválida de OpenAI: ' + text);
      }

      const imageUrl = data?.data?.[0]?.url;
      if (!imageUrl) {
        throw new Error('OpenAI no devolvió una imagen válida.');
      }

      renderImageDesign(imageUrl);

    } catch (error) {
      console.error('Error al generar el afiche:', error);
      alert('Error al generar el afiche: ' + error.message);
      generatingState.classList.add('hidden');
      loadingState.classList.remove('hidden');
      return;
    }
  });

  function renderImageDesign(imageUrl) {
    previewContent.innerHTML = `
      <div class="w-full h-full relative">
        <img src="${imageUrl}" class="w-full h-full object-cover rounded-xl" alt="Afiche generado">
        
        ${logoBase64 ? `
        <div class="absolute top-8 left-1/2 transform -translate-x-1/2">
          <img src="${logoBase64}" class="w-24 h-24 rounded-full border-4 border-white shadow-2xl object-cover">
        </div>` : '' }
        
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white/95 backdrop-blur rounded-full px-6 py-2 shadow-lg">
          <p class="text-xs font-black text-gray-800">Vista generada con IA</p>
        </div>
      </div>
    `;

    generatingState.classList.add('hidden');
    previewContent.classList.remove('hidden');
    goToStep(3);
  }

  // Botones de navegación
  backBtn1.addEventListener('click', () => goToStep(1));
  backBtn2.addEventListener('click', () => goToStep(2));
</script>



</body>
</html>
